APT Attack Analysis of Darkhotel (APT-C-06) Exploiting Double Star 0Day Vulnerabilities (CVE-2019-17026 CVE-2020-0674) Targeting China
Background On January 14 2020 Microsoft officially announced the end of support for Windows 7. The next day on January 15 2020 360 Security Brain captured the first compound attack exploiting two 0day vulnerabilities in both IE and Firefox browsers globally which was named "Double Star" 0day attack. The vulnerabilities were reported to Microsoft and Mozilla respectively and officially confirmed as CVE-2019-17026 (Firefox) and CVE-2020-0674 (IE). Through analysis and溯源 by 360 Advanced Threat Response Team the Double Star 0day vulnerabilities were exploited by Darkhotel (APT-C-06) a peninsula-based APT group active for over a decade targeting Chinese government agencies related to commerce. Attack Process Analysis The attack combines multiple methods including Office vulnerability documents webpage挂马 and WPAD local privilege escalation. The complete attack chain involves: IE loading JS-1 exploit to gain code execution then triggering WPAD service via winhttp APIs. The WPAD service downloads JS-1 again executes shellcode checks svchost process name downloads subsequent files and performs DCOM privilege escalation (Win7) or BITS service escalation (Win10) before executing final payload. Attack Details The exploit webpage detects browser type (IE/Firefox) and OS architecture (32/64-bit) to load corresponding exploit code. Attackers conducted both webpage挂马 and Office document attacks (using CVE-2017-11882) with诱饵文档 that triggers IE browser to access malicious pages. The IE vulnerability (CVE-2020-0674) is a UAF flaw in Jscript engine where Array.Sort callback parameters escape GC tracking allowing attackers to trigger UAF for arbitrary code execution. Post-exploitation shellcode checks svchost process status: if running in IE it triggers WPAD service to load remote PAC file (containing same JS exploit); if in svchost it downloads and executes final Trojan from temp directory. The final Trojan communicates with fixed C&C URLs to execute arbitrary commands on victim machines.